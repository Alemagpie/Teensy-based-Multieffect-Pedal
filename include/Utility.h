#ifndef UTILITY_H
#define UTILITY_H

#include <Arduino.h>
#include <Audio.h>
#include "CustomRange.h"
#include <dspinst.h>

constexpr int16_t TANH_MAX = 3;
constexpr int TANH_ENTRIES = 120;
constexpr int16_t INV_TANH_STEP = (TANH_ENTRIES)/TANH_MAX;
constexpr float INV_TANH_SCALE = 1.0f/32767.0f;
PROGMEM static const int16_t tanhLUT[TANH_ENTRIES] = {
    0, 819, 1636, 2452, 3265, 4074, 4878, 5676, 6467, 7250, 8025, 8790, 9545, 10289, 11022, 11742, 
    12449, 13143, 13824, 14490, 15142, 15778, 16400, 17006, 17597, 18172, 18731, 19275, 19803, 20315, 
    20811, 21292, 21758, 22208, 22644, 23064, 23470, 23862, 24240, 24604, 24955, 25292, 25617, 25929, 
    26229, 26518, 26795, 27061, 27316, 27561, 27795, 28020, 28236, 28442, 28640, 28829, 29010, 29183, 
    29349, 29507, 29658, 29803, 29942, 30074, 30200, 30320, 30435, 30545, 30650, 30750, 30846, 30937, 
    31023, 31106, 31185, 31261, 31333, 31401, 31466, 31528, 31588, 31644, 31698, 31749, 31798, 31845, 
    31889, 31931, 31972, 32010, 32046, 32081, 32114, 32146, 32176, 32204, 32232, 32257, 32282, 32306, 
    32328, 32349, 32369, 32389, 32407, 32424, 32441, 32457, 32472, 32486, 32500, 32513, 32525, 32537, 
    32548, 32559, 32569, 32578, 32587, 32596, 
};


constexpr int SIN_ENTRIES = 419;
PROGMEM static const int16_t sinLUT[SIN_ENTRIES] = {
    0, 491, 982, 1474, 1964, 2455, 2945, 3434, 3922, 4410, 4896, 5382, 5866, 6349, 6830, 7310, 
    7788, 8265, 8739, 9212, 9683, 10151, 10617, 11081, 11542, 12001, 12457, 12910, 13361, 13808, 
    14252, 14693, 15131, 15565, 15996, 16423, 16846, 17266, 17682, 18093, 18501, 18905, 19304, 
    19699, 20089, 20476, 20857, 21234, 21606, 21973, 22335, 22692, 23044, 23391, 23732, 24068, 
    24399, 24725, 25044, 25358, 25667, 25969, 26266, 26557, 26842, 27121, 27394, 27660, 27921, 
    28175, 28422, 28664, 28899, 29127, 29349, 29564, 29773, 29975, 30170, 30358, 30540, 30714, 
    30882, 31043, 31197, 31343, 31483, 31616, 31741, 31860, 31971, 32075, 32172, 32261, 32344, 
    32419, 32487, 32547, 32600, 32646, 32684, 32716, 32739, 32756, 32765, 32766, 32760, 32747, 
    32727, 32699, 32664, 32621, 32571, 32514, 32450, 32378, 32299, 32212, 32119, 32018, 31910, 
    31794, 31672, 31542, 31406, 31262, 31111, 30954, 30789, 30617, 30439, 30253, 30061, 29862, 
    29657, 29444, 29225, 29000, 28768, 28529, 28284, 28033, 27775, 27512, 27241, 26965, 26683, 
    26395, 26101, 25800, 25495, 25183, 24866, 24543, 24214, 23881, 23541, 23197, 22847, 22492, 
    22132, 21767, 21398, 21023, 20644, 20260, 19871, 19478, 19081, 18679, 18273, 17863, 17449, 
    17031, 16609, 16184, 15755, 15322, 14886, 14446, 14003, 13557, 13108, 12657, 12202, 11744, 
    11284, 10821, 10356, 9889, 9419, 8947, 8474, 7998, 7520, 7041, 6560, 6078, 5594, 5109, 4623, 
    4136, 3648, 3159, 2670, 2180, 1689, 1198, 707, 215, -275, -767, -1258, -1749, -2239, -2730, 
    -3219, -3708, -4196, -4683, -5169, -5653, -6137, -6619, -7100, -7579, -8056, -8531, -9005, 
    -9476, -9946, -10413, -10878, -11340, -11800, -12257, -12712, -13163, -13612, -14057, -14500, 
    -14939, -15375, -15807, -16236, -16661, -17082, -17500, -17913, -18323, -18728, -19129, -19526, 
    -19919, -20307, -20690, -21069, -21443, -21812, -22176, -22536, -22890, -23239, -23583, -23922, 
    -24255, -24582, -24905, -25221, -25532, -25837, -26137, -26430, -26718, -26999, -27275, -27544, 
    -27807, -28064, -28314, -28559, -28796, -29028, -29252, -29470, -29682, -29887, -30085, -30276, 
    -30461, -30638, -30809, -30973, -31130, -31280, -31423, -31558, -31687, -31809, -31923, -32030, 
    -32130, -32223, -32309, -32387, -32458, -32521, -32578, -32627, -32668, -32703, -32730, -32749, 
    -32762, -32766, -32764, -32754, -32737, -32712, -32680, -32641, -32594, -32540, -32479, -32410, 
    -32334, -32251, -32161, -32063, -31958, -31846, -31727, -31600, -31467, -31326, -31178, -31024, 
    -30862, -30693, -30518, -30336, -30146, -29950, -29748, -29538, -29322, -29100, -28871, -28635, 
    -28393, -28144, -27889, -27628, -27361, -27087, -26808, -26522, -26231, -25933, -25630, -25321, 
    -25006, -24685, -24360, -24028, -23691, -23349, -23002, -22649, -22291, -21929, -21561, -21188, 
    -20811, -20429, -20043, -19651, -19256, -18856, -18452, -18044, -17632, -17215, -16795, -16371, 
    -15944, -15513, -15078, -14640, -14199, -13754, -13306, -12856, -12402, -11946, -11487, -11025, 
    -10561, -10095, -9626, -9155, -8682, -8207, -7731, -7252, -6772, -6291, -5807, -5323, -4838, 
    -4351, -3863, -3375, -2886, -2396, -1905, -1414, -923, -432, 
};

class Utility {
    public:
    //static int16_t inline calculateParamValue(CustomRange& r, int16_t& l) { return (l>= 0) ? saturate16(r.getMin() + signed_saturate_rshift(l * r.getDelta(), 16, 15)) : 0; }
    
    static float inline calculateParamValue(CustomRange& r, float l) {return r.getMin() + l * r.getDelta();}
    static int16_t fastTanh(int16_t x);
    static int16_t fastSin(int16_t x);
};

#endif